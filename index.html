// üöÄ SaaS Configuration Handler - Arquitectura correcta con SSO
const BACKEND_URL = "https://teampulse-e3gvgbhncvemchdf.brazilsouth-01.azurewebsites.net";

// Configuraci√≥n MSAL para SSO
let msalInstance = null;
let ssoConfig = null;

function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

function showSaasOverlay() {
    document.getElementById("saasOverlay").style.display = "flex";
}

function hideSaasOverlay() {
    document.getElementById("saasOverlay").style.display = "none";
}

function updateSaasContent(html) {
    document.getElementById("saasContent").innerHTML = html;
}

// ‚îÄ‚îÄ Obtener configuraci√≥n SSO del backend
async function getSsoConfig() {
    try {
        const response = await fetch(`${BACKEND_URL}/api/marketplace/landing/sso-config`);
        const config = await response.json();
        console.log("üîß SSO Config:", config);
        return config;
    } catch (error) {
        console.error("‚ùå Error obteniendo configuraci√≥n SSO:", error);
        throw error;
    }
}

// ‚îÄ‚îÄ Inicializar MSAL para SSO
async function initializeMsal() {
    try {
        // Cargar MSAL desde CDN
        if (!window.msal) {
            await loadMsalScript();
        }

        ssoConfig = await getSsoConfig();
        
        const msalConfig = {
            auth: {
                clientId: ssoConfig.landingClientId,
                authority: ssoConfig.authority,
                redirectUri: window.location.origin + "/api/marketplace/landing/callback"
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        msalInstance = new msal.PublicClientApplication(msalConfig);
        await msalInstance.initialize();
        
        console.log("‚úÖ MSAL inicializado correctamente");
        return true;
    } catch (error) {
        console.error("‚ùå Error inicializando MSAL:", error);
        return false;
    }
}

// ‚îÄ‚îÄ Cargar script de MSAL
function loadMsalScript() {
    return new Promise((resolve, reject) => {
        if (window.msal) {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// ‚îÄ‚îÄ Realizar login SSO
async function performSsoLogin() {
    try {
        console.log("üîê Iniciando SSO login...");
        
        updateSaasContent(`
            <div class="spinner"></div>
            <h2>Iniciando sesi√≥n con Microsoft...</h2>
            <p>Ser√°s redirigido a Microsoft para autenticarte.</p>
        `);

        const loginRequest = {
            scopes: ssoConfig.scopes,
            prompt: "select_account"
        };

        const result = await msalInstance.loginPopup(loginRequest);
        console.log("‚úÖ SSO login exitoso:", result);
        
        return result.idToken;
    } catch (error) {
        console.error("‚ùå Error en SSO login:", error);
        throw error;
    }
}

// ‚îÄ‚îÄ Procesar configuraci√≥n SaaS con SSO
async function processSaasConfiguration(marketplaceToken) {
    try {
        console.log("üöÄ Procesando configuraci√≥n SaaS con SSO...");
        console.log("üé´ Marketplace token (primeros 50 chars):", marketplaceToken.substring(0, 50));

        updateSaasContent(`
            <div class="spinner"></div>
            <h2>Preparando tu suscripci√≥n...</h2>
            <p>Configurando autenticaci√≥n segura...</p>
        `);

        // Paso 1: Inicializar MSAL
        const msalReady = await initializeMsal();
        if (!msalReady) {
            throw new Error("No se pudo inicializar el sistema de autenticaci√≥n");
        }

        // Paso 2: Realizar SSO login
        const idToken = await performSsoLogin();

        // Paso 3: Enviar ambos tokens al backend
        updateSaasContent(`
            <div class="spinner"></div>
            <h2>Activando tu suscripci√≥n...</h2>
            <p>Procesando tu informaci√≥n y activando el servicio...</p>
        `);

        const response = await fetch(`${BACKEND_URL}/api/marketplace/landing/activate`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ 
                marketplaceToken,
                idToken 
            })
        });

        console.log("üì° Response status:", response.status);

        if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ Resultado exitoso:", result);
            
            updateSaasContent(`
                <div class="success-icon">üéâ</div>
                <h2>¬°Suscripci√≥n Activada!</h2>
                <p>Tu suscripci√≥n a TeamPulse ha sido activada correctamente.</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p><strong>üìã Detalles de la activaci√≥n:</strong></p>
                    <p>‚Ä¢ <strong>Usuario:</strong> ${result.user?.name || 'N/A'}</p>
                    <p>‚Ä¢ <strong>Email:</strong> ${result.user?.email || 'N/A'}</p>
                    <p>‚Ä¢ <strong>Suscripci√≥n ID:</strong> ${result.subscriptionId || 'N/A'}</p>
                    <p>‚Ä¢ <strong>Plan:</strong> ${result.planId || 'N/A'}</p>
                    <p>‚Ä¢ <strong>Activado:</strong> ${new Date(result.timestamp || Date.now()).toLocaleString()}</p>
                </div>
                <p><strong>üöÄ ¬°Ya puedes comenzar a usar TeamPulse en Microsoft Teams!</strong></p>
                <br>
                <a href="https://teams.microsoft.com" target="_blank" class="saas-button">
                    Abrir Microsoft Teams
                </a>
                <button onclick="hideSaasOverlay()" class="saas-button">Cerrar</button>
            `);

            // Opcional: Mostrar notificaci√≥n de √©xito
            setTimeout(() => {
                if (confirm("¬øQuieres abrir Microsoft Teams ahora para empezar a usar TeamPulse?")) {
                    window.open("https://teams.microsoft.com", "_blank");
                }
            }, 3000);

        } else {
            let errorMessage = `Error ${response.status}`;
            let errorDetails = "";
            
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
                errorDetails = errorData.details || "";
            } catch {
                errorMessage = await response.text() || errorMessage;
            }
            
            console.error("‚ùå Error en respuesta:", errorMessage, errorDetails);
            
            updateSaasContent(`
                <div class="error-icon">‚ùå</div>
                <h2>Error al Activar Suscripci√≥n</h2>
                <p>Hubo un problema al activar tu suscripci√≥n a TeamPulse.</p>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>Error:</strong> ${errorMessage}</p>
                    ${errorDetails ? `<p><strong>Detalles:</strong> ${errorDetails}</p>` : ''}
                    <p><strong>C√≥digo:</strong> ${response.status}</p>
                </div>
                <p>Por favor, contacta a nuestro equipo de soporte con esta informaci√≥n.</p>
                <br>
                <button onclick="processSaasConfiguration('${marketplaceToken}')" class="saas-button">
                    üîÑ Reintentar
                </button>
                <a href="mailto:support@incumate.io?subject=Error activando TeamPulse&body=Error: ${encodeURIComponent(errorMessage)}%0ADetalles: ${encodeURIComponent(errorDetails)}%0AC√≥digo: ${response.status}" class="saas-button">
                    üìß Contactar Soporte
                </a>
                <button onclick="hideSaasOverlay()" class="saas-button">Cerrar</button>
            `);
        }

    } catch (error) {
        console.error("üí• Error de proceso:", error);
        
        updateSaasContent(`
            <div class="error-icon">üåê</div>
            <h2>Error de Configuraci√≥n</h2>
            <p>No se pudo completar la configuraci√≥n de la suscripci√≥n.</p>
            <p><strong>Error:</strong> ${error.message}</p>
            <p>Esto puede deberse a problemas de conectividad o configuraci√≥n.</p>
            <br>
            <button onclick="processSaasConfiguration('${marketplaceToken}')" class="saas-button">
                üîÑ Reintentar
            </button>
            <button onclick="hideSaasOverlay()" class="saas-button">Cerrar</button>
        `);
    }
}

// üîç Detectar token al cargar la p√°gina
document.addEventListener("DOMContentLoaded", () => {
    const token = getUrlParameter("token");
    if (token) {
        console.log("üéØ Token de configuraci√≥n detectado");
        console.log("üîó Usando arquitectura SSO completa");
        showSaasOverlay();
        // Peque√±a pausa para que se vea la UI
        setTimeout(() => processSaasConfiguration(token), 1000);
    }
});

// üõ†Ô∏è Funciones de debug (√∫tiles para testing)
window.testSaasConfig = function(testToken) {
    const token = testToken || prompt("Ingresa un token de prueba:");
    if (token) {
        showSaasOverlay();
        processSaasConfiguration(token);
    }
};

window.debugMarketplace = function() {
    console.log("=== üîß DEBUG MARKETPLACE (SSO) ===");
    console.log("Backend URL:", BACKEND_URL);
    console.log("Landing endpoint:", `${BACKEND_URL}/api/marketplace/landing/activate`);
    console.log("SSO config endpoint:", `${BACKEND_URL}/api/marketplace/landing/sso-config`);
    console.log("Current URL:", window.location.href);
    console.log("URL Params:", window.location.search);
    console.log("Token detected:", !!getUrlParameter("token"));
    console.log("MSAL loaded:", !!window.msal);
    console.log("MSAL instance:", !!msalInstance);
};

// üè• Health checks
window.checkLandingHealth = async function() {
    try {
        const response = await fetch(`${BACKEND_URL}/api/marketplace/landing/health`);
        const result = await response.json();
        console.log("üè• Landing page health:", result);
        
        const status = `
Landing Page Status: ${result.status}
Architecture: ${result.architecture}
Landing App: ${result.apps?.landing?.clientId}
API App: ${result.apps?.api?.clientId}
        `;
        alert(status);
    } catch (error) {
        console.error("‚ùå Landing page health check failed:", error);
        alert("‚ùå Landing page endpoint no disponible");
    }
};

window.testSsoConfig = async function() {
    try {
        const config = await getSsoConfig();
        console.log("üîß SSO Config test:", config);
        alert(`SSO Config OK\nClient ID: ${config.landingClientId}\nAuthority: ${config.authority}`);
    } catch (error) {
        console.error("‚ùå SSO config test failed:", error);
        alert("‚ùå No se pudo obtener configuraci√≥n SSO");
    }
};